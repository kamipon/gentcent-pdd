<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>修改商品</title>
	<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" name="viewport"/>
	<meta content="yes" name="apple-mobile-web-app-capable"/>
	<meta content="black" name="apple-mobile-web-app-status-bar-style"/>
	<meta content="telephone=no" name="format-detection"/>
	<link href="../../css/bootstrap.min.css" rel="stylesheet">
	<link href="addGoods.css" rel="stylesheet" type="text/css"/>
	<style>
		* {margin: 0;padding: 0;}
		#article-body {width: 100%;min-height: 300px;box-sizing: border-box;padding: 10px;color: #444;background-color: #fff;border: 1px solid #ccc;border-radius: 0 0 4px 4px;}
		#article-body img {width: 100%;}
		.btn-primary.active.focus, .btn-primary.active:focus, .btn-primary.active:hover, .btn-primary:active.focus, .btn-primary:active:focus, .btn-primary:active:hover, .open > .dropdown-toggle.btn-primary.focus, .open > .dropdown-toggle.btn-primary:focus, .open > .dropdown-toggle.btn-primary:hover {outline: none !important;background-color: #5cb85c !important;border-color: #5cb85c !important;}
		.btn-primary.active, .btn-primary:active, .open>.dropdown-toggle.btn-primary{	background-color: #5cb85c;border-color: #5cb85c;}
		.btn-primary {outline: none !important;color: #000;background-color: #f3f3f3;border-color: #ccc;}
		#addImg input {display: none;}
		#fileList img {height: 30vw;width: 30vw;}
		.thumbnail {margin-bottom: 0;margin-right: 12px;float: left;}
		.X{position: absolute;top: 10px;right: 64px;z-index: 9;font-size: 18px;color: gray;}
	</style>
</head>
<body>
<!-- 顶部导航栏 -->
<div id="top"></div>

<div class="container">
	<div class="item-content">
		<div class="item-media"><i class="icon icon-form-gender"></i></div>
		<div class="item-inner">
			<div class="item-input">
				<div class="uploader-list"></div>
			</div>
		</div>
	</div>
	<div class="input-group" style="height: 35px;">
		<span class="input-group-addon" id="addImg" style="width: 100vw;border: 1px solid #ccc !important;border-bottom: 0px !important;border-radius: 4px 4px 0 0 !important;">
			<button class="btn" style="color: #fff;background-color: #5cb85c;">添加商品图片</button>
			<span class="X" onclick="clearImg()" style="top: 13px;right: 10px;"><img height="17px" src="../order/images/delete.png"></span></span>
		</span>
	</div>
	<div class="input-group" style="margin: 0;border-top: none;">
		<div class="form-control col-xs-10" name="imglist" disabled
				 style="border-top: none;height: 37.2vw;width:91vw;white-space: nowrap;overflow: auto;">
			<div id="fileList" style="width: 1000vw;"></div>
		</div>
	</div>
	<div class="input-group">
		<span class="input-group-addon">商品分类</span>
		<span class="X" onclick="clearCategory()"><img height="17px" src="../order/images/delete.png"></span>
		<input type="text" class="form-control col-xs-10" placeholder="" name="category" disabled>
		<span class="btn input-group-addon" id="addCategory"
					style="color: #fff; background-color: #5cb85c; border-radius: 0 5px 5px 0;">添加</span>
	</div>
	<div class="input-group">
		<span class="input-group-addon">商品标题</span>
		<input type="text" class="form-control" name="title">
	</div>
	<div class="input-group">
		<span class="input-group-addon">副标题</span>
		<input type="text" class="form-control" name="subhead">
	</div>
	<div class="input-group">
		<span class="input-group-addon">客服电话</span>
		<input type="number" class="form-control" name="telphone">
	</div>
	<div class="input-group">
		<span class="input-group-addon">是否使用规格</span>
		<div class="btn-group" data-toggle="buttons" style="width: 100%;">
			<label class="btn btn-primary active" style="padding: 11.5px;width: 50%;border-radius: 0px;">
				<input type="radio" name="isSpecs" id="option1" autocomplete="off" value="0"> 关闭
			</label>
			<label class="btn btn-primary" style="padding: 11.5px;width: 50%;">
				<input type="radio" name="isSpecs" id="option2" autocomplete="off" value="1"> 开启
			</label>
		</div>
	</div>
	<div class="input-group" style="height: 35px;">
			<span class="input-group-addon"
						style="width: 100vw;border: 1px solid #ccc !important;border-bottom: 0px !important;border-radius: 4px 4px 0 0 !important;">
				商品描述
			</span>
	</div>
	<div id="article-body"></div>
</div>

<div style="height: 30px"></div>

<div class="img-farme" style="display: none;">
	<img style="width: 100%;padding: 5px;">
</div>

</body>

<!-- 引入jQuery核心js文件 -->
<script src="../../js/eleditor/jquery.min.js"></script>
<script src="../../js/eleditor/webuploader.min.js"></script>
<script src="../../js/eleditor/Eleditor.js"></script>
<script src="../../js/layer.js"></script>
<!-- 引入BootStrap核心js文件 -->
<script src="../../js/bootstrap.min.js"></script>
<script type="text/javascript">

    var imgListArr = [];

    // 初始化Web Uploader
    var uploader = WebUploader.create({
        // 选完文件后，是否自动上传。
        auto: true,
        // swf文件路径
        swf: '../../js/webuploader/Uploader.swf',
        // 文件接收服务端。
        server: '/wx_plugin/fileUploads',
        // 选择文件的按钮。可选。
        pick: '#addImg',
        // 只允许选择图片文件。
        accept: {
            title: 'Images',
            extensions: 'gif,jpg,jpeg,bmp,png',
            mimeTypes: 'image/*'
        },
        compress:{
            width: 600,
            quality: 90,
            compressSize: 512000
        },
        multiple:true
    });
    // 当有文件添加进来的时候
    uploader.on('fileQueued', function (file) {
        var $li = $(
            '<div id="' + file.id + '" class="thumbnail">' +
            '<img>' +
            '</div>'
        )
        // $list为容器jQuery实例
        $("#fileList").append($li);
        // 创建缩略图
        uploader.on('uploadSuccess', function (file2, response) {
            console.log(response);
            if (!response.flag) {
                $("#" + file2.id).remove();
                layer.msg(response.msg);
                return;
            }
            $("#" + file2.id).attr('onclick', "scaleImg('" + response.src + "')");
            $("#" + file2.id).find('img').attr('src', response.src);
            if ($.inArray(response.src, imgListArr) < 0) {
                imgListArr.push(response.src);
            }
        });
    });

    // 文件上传失败，显示上传出错。
    uploader.on('uploadError', function (file) {
        alert("上传失败");
    });

    function scaleImg(src){
        $(".img-farme > img").attr("src",src);
        layer.open({
            type: 1,
            title: false,
            closeBtn: true,
            area: ["85%", "auto"],
            content: $(".img-farme"),
            success: function (index, layero) {
            },
            cancel: function (index, layero) {
            }
        })
    }

    $(document).ready(function () {
        $("[name=imglist]").width($("body").width()-56);
        $.ajax({
            url: "/wx_wlgoods/" + getQueryString("id"),
            type: "get",
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.flag) {
                    let goods = data.wlgoods;
                    let categoryList = data.list;
                    console.log(data);
                    $("#article-body").html(goods.desc);
                    $("input[name=subhead]").val(goods.subhead);
                    $("input[name=title]").val(goods.title);
                    $("input[name=telphone]").val(goods.telphone);
                    $("#option" + data.option).click();
                    let imgHtml = "";
                    imgListArr = JSON.parse(goods.imgList);
                    for (let i = 0; i < imgListArr.length; i++) {
                        const src = imgListArr[i];
                        imgHtml +=
                            '<div id="IMG_' + i + '" class="thumbnail" onclick="scaleImg(\'' + src + '\')">' +
                            '<img src="' + src + '">' +
                            '</div>';
                    }
                    $("#fileList").html(imgHtml);
                    let catHtml = "";
                    for (let i = 0; i < categoryList.length; i++) {
                        const cat = categoryList[i].category;
                        _categoryList.push(cat.id);
                        if (i != 0) catHtml += " , ";
                        catHtml += cat.name;
                    }
                    $("input[name=category]").val(catHtml);
                    var category = JSON.stringify(_categoryList);
                } else {
                    layer.msg(data.msg);
                }
            }
        });
    });

    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var reg_rewrite = new RegExp("(^|/)" + name + "/([^/]*)(/|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        var q = window.location.pathname.substr(1).match(reg_rewrite);
        if (r != null) {
            return unescape(r[2]);
        } else if (q != null) {
            return unescape(q[2]);
        } else {
            return null;
        }
    }


    function delImg(id, src) {
        layer.confirm('确定删除图片？', {
            btn: ['确定', '取消'], //按钮
            title: false,
            icon: 3,
            closeBtn: false
        }, function (i) {
            $("#" + id).remove();
            var index = $.inArray(src, imgListArr);
            imgListArr.splice(index, 1);
            layer.close(i);
        }, function (i) {
            layer.close(i);
        });
    }

    function clearImg(){
        layer.confirm('确定清空图片？', {
            btn: ['确定', '取消'], //按钮
            title: false,
            icon: 3,
            closeBtn: false
        }, function (i) {
            imgListArr = [];
            $("#fileList").html("");
            layer.close(i);
        }, function (i) {
            layer.close(i);
        });
    }

    $("#top").load("../top.html", function () {
        $("#top_title").html("商品简介");
        $("#top_url").attr("href", "myGoods.html");
        $("#top_right").html("<a href='javascript:next();' class=\"btn btn-success\" style='color:#fff;'>下一步</a>")
        $(".kele").hide();
    });

    $("#addCategory").click(function () {
        layer.open({
            type: 2,
            title: "添加分类",
            shadeClose: false,
            shade: 0.6,
            closeBtn: 1,
            area: ["90%", "auto"],
            content: "addCategory.html",
            success: function (index, layero) {
            },
            cancel: function (index, layero) {
            }
        });
    });

    var _categoryList = [];

    /*实例化一个编辑器*/
    var artEditor = new Eleditor({
        el: '#article-body',
        upload: {
            server: '/wx_plugin/fileUploads',//后台接收地址
            fileSizeLimit: 5,//限制文件上传大小为2M
            formName: 'image',//设置文件name,
            accept: {
                title: 'Images',
                extensions: 'gif,jpg,jpeg,bmp,png',
                mimeTypes: 'image/*'
            }

        },
        changer: function () {
            $("#top").show();
        }
    });
    $(".Eleditor-controller li").click(function () {
        $("#top").hide();
    });
    $(".Eleditor-cancel").click(function () {
        $("#top").show();
    });
    
    function clearCategory(){
        layer.confirm('确定清空分类？', {
            btn: ['确定', '取消'], //按钮
            title: false,
            icon: 3,
            closeBtn: false
        }, function (i) {
            _categoryList = [];
            $("input[name=category]").val("");
            layer.close(i);
        }, function (i) {
            layer.close(i);
        });
		}

    function next() {
        var isSpecs = $(".btn.btn-primary.active > input[name=isSpecs]").val();
        var category = JSON.stringify(_categoryList);
        var title = $("input[name=title]").val();
        var subhead = $("input[name=subhead]").val();
        if (_categoryList.length == 0 || title == "") {
            alert("请输入完整信息！")
            return;
        }
        var telphone = $("input[name=telphone]").val();
        var desc = artEditor.getContent();
        $.ajax({
            url: "/wx_wlgoods/updategoods",
            type: "post",
            data: {
                id: getQueryString("id"),
                imgList: JSON.stringify(imgListArr),
                category: category,
                title: title,
                subhead: subhead,
                telphone: telphone,
                desc: desc
            },
            dataType: "json",
            success: function (data) {
                if (data.flag) {
                    layer.msg(
                        data.msg,
                        {time: 1000},
                        function () {
                            if (isSpecs == 1) {
                                $.ajax({
                                    url: "/wx_wlgoods/goods_specs/del",
                                    type: "post",
                                    data: {
                                        goodsId: data.wlgoodsId,
                                        specsId: "1"
																		},
                                    dataType: "json",
                                    success: function (data2) {
                                        if (data2.flag) {
                                            location.href = "addGoods2.html?wlgoodsId=" + data.wlgoodsId;
                                        }else{
                                            layer.msg(data2.msg);
                                        }
                                    }
                                });
                                
                            } else {
                                $.ajax({
                                    url: "/wx_wlgoods/goods_specs/delAll",
                                    type: "post",
                                    data: {goodsId: data.wlgoodsId},
                                    dataType: "json",
                                    success: function (data2) {
                                        if (data2.flag) {
                                            location.href = "addGoods2-default.html?wlgoodsId=" + data.wlgoodsId;
                                        }else{
                                            layer.msg(data2.msg);
																				}
                                    }
                                });
                                
                            }
                        }
                    );
                }
            }
        });
    }
</script>
</html>