<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>修改商品</title>
	<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" name="viewport"/>
	<meta content="yes" name="apple-mobile-web-app-capable"/>
	<meta content="black" name="apple-mobile-web-app-status-bar-style"/>
	<meta content="telephone=no" name="format-detection"/>
	<link href="../../css/bootstrap.min.css" rel="stylesheet">
	<link href="addGoods.css" rel="stylesheet" type="text/css"/>
	<link rel="stylesheet" href="../../css/jquery.richUI.min.css"/>
	<style>
		.page-header {
			padding-bottom: 9px;
			margin: 10px 0 20px;
			border-bottom: 1px solid #ccc;
		}
		
		input[type=number] {
			text-align: right
		}
		
		.xx {
			background-color: grey !important;
		}
	</style>
</head>
<body>
<!-- 顶部导航栏 -->
<div id="top"></div>

<!-- 规格 -->
<div class="container">
	<div class="container" style="margin-top: 10px;display: none;">
		<div class="input-group">
			<span class="input-group-addon" style="width: 95px;">已添加规格</span>
			<select id='specs' class='form-control' style="background-color: #f5f5f5;">
				<option value="1" selected>默认</option>
			</select>
		</div>
	</div>
	<h5 class="page-header" style="margin: 15px 0 15px;"></h5>
	<div class="container">
		<div class="input-group" id="limit-jg" style="display: none;">
			<span class="input-group-addon">价格</span>
			<input type="number" class="form-control" name="price">
			<span class="input-group-addon">元</span>
		</div>
		<div class="input-group" id="limit-dj" style="display: none;">
			<span class="input-group-addon">定金</span>
			<input type="number" class="form-control" name="deposit">
			<span class="input-group-addon">元</span>
		</div>
		<div class="input-group">
			<span class="input-group-addon">参考价格</span>
			<input type="number" class="form-control" name="onprice">
			<span class="input-group-addon">元</span>
		</div>
		<div class="input-group">
			<span class="input-group-addon">库存</span>
			<input type="number" class="form-control" name="num">
			<span class="input-group-addon">件</span>
		</div>
	</div>
</div>

<h5 class="page-header"></h5>

</body>

<script type="text/javascript" src="../../js/jquery-1.11.3.min.js"></script>
<script src="../../js/layer.js"></script>
<script src="../../js/bootstrap.min.js"></script>
<script type="text/javascript">

    var goodsId = getQueryString("wlgoodsId");

    function save() {
        var specsId = $("#specs").val();
        var num = $("input[name=num]").val();
        var onprice = $("input[name=onprice]").val();

        var param = {
            goodsId: goodsId,
            specsId: specsId,
            num: num,
            onprice: onprice
        };

        if(_limit!=1){
            var price = $("input[name=price]").val();
            var deposit = $("input[name=deposit]").val();
            param.price = price;
            param.deposit = deposit;
            if(price == null || price == "" ||
                deposit == null || deposit == ""){
                alert("请输入完整信息！");
                return;
            }
            if(parseFloat(deposit)>parseFloat(price)){
                alert("定金不要高于价格！");
                return;
            }
            if(parseFloat(price)<parseFloat(onprice)){
                alert("价格需大于参考价！");
                return;
            }
        }

        if (goodsId == "" || specsId == ""
            ||specsId == "-1" || num == ""
            || onprice == "") {
            alert("请输入完整信息！");
            return;
        }

        $.ajax({
            url: "/wx_wlgoods/goods_specs",
            type: "post",
            data: param,
            dataType: "json",
            success: function (data) {
                layer.msg(
                    data.msg,
                    {
                        time: 1000,
                        end: function () {
                            if (data.flag) {
																location.href = "goodsDetail.html?id=" + getQueryString("wlgoodsId");
                            }
                        }
                    })
            }
        });
    }

    var _szjg = getQueryString("szjg");
    $("#top").load("../top.html", function () {
        $("#top_title").html("商品规格");
        $("#top_url").attr("href", "myGoods.html");
        $("#top_right").html("<a href='javascript:save();' style='color:#fff;' class=\"btn btn-success\">下一步</a>")
        if(_szjq==null){
            $(".kele").hide();
        }
    });

    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var reg_rewrite = new RegExp("(^|/)" + name + "/([^/]*)(/|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        var q = window.location.pathname.substr(1).match(reg_rewrite);
        if (r != null) {
            return unescape(r[2]);
        } else if (q != null) {
            return unescape(q[2]);
        } else {
            return null;
        }
    }

    var _limit;
    $(document).ready(function () {
			//数据回显
			$.ajax({
					url: "/wx_wlgoods/" + getQueryString("wlgoodsId"),
					type: "get",
					data: {},
					dataType: "json",
					success: function (data) {
							if (data.flag) {
                  _limit = data.limit;
                  if(_limit!=1){
                      $("#limit-jg").show();
                      $("#limit-dj").show();
                  }
							    
									let defaultSpecs = data.slist[0];
									$("input[name=price]").val(defaultSpecs.price);
									$("input[name=onprice]").val(defaultSpecs.onprice);
									$("input[name=deposit]").val(defaultSpecs.deposit);
									$("input[name=num]").val(defaultSpecs.num);
									$("option[value=" + defaultSpecs.moneyid + "]").attr("selected", "selected");
									$("#moneyid").val(defaultSpecs.moneyid);
									let specsList = data.slist;
									for (let i = 0; i < specsList.length; i++) {
											const goodsSpecs = specsList[i];
											var selected = "";
											if (i == 0) selected = "selected";
											var option = "<option value='" + goodsSpecs.specs.id + "' " + selected + ">" + goodsSpecs.specs.name + "</option>";
											$("#specs").append(option);
											_flag = true;
											$("#delBtn").removeClass("xx");
									}
							} else {
									layer.msg(data.msg);
							}
					}
			});
    });
</script>
</html>