<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>选择收货地址</title>
	<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" name="viewport"/>
	<meta content="yes" name="apple-mobile-web-app-capable"/>
	<meta content="black" name="apple-mobile-web-app-status-bar-style"/>
	<meta content="telephone=no" name="format-detection"/>
	<link href="../../css/bootstrap.min.css" rel="stylesheet">
	<link href="css/addAddress.css" rel="stylesheet">
	<link rel="stylesheet" href="css/ydui.css?rev=@@hash"/>
	<script src="js/ydui.flexible.js"></script>
	<link href="css/style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<header class="aui-navBar aui-navBar-fixed">
	<a href="javascript:history.go(-1);" class="aui-navBar-item">
		<i class="icon icon-return"></i>
	</a>
	<div class="aui-center">
		<span class="aui-center-title">收货地址管理</span>
	</div>
</header>

<div class="item-box">
	<div class="item">
		<label>
			<div class="title">收货人</div>
			<input type="text" name="name">
		</label>
	</div>
	<div class="item">
		<label>
			<div class="title">联系电话</div>
			<input type="text" name="phone">
		</label>
	</div>
	<div class="item">
		<label>
			<div class="title">所在地区</div>
			<input type="text" class="cell-input" readonly id="J_Address" placeholder="请选择地址">
		</label>
	</div>
	<div class="item">
		<label>
			<div class="title">详细地址</div>
			<input type="text" name="location">
		</label>
	</div>
</div>

<div class="btn-box">
	<button class="btn btn-danger" id="save_or_update_btn" onclick="save()">保存</button>
</div>

</body>
<script src="../../js/jquery-1.11.3.min.js"></script>
<script src="../../js/layer.js"></script>
<script src="../../js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/ydui.citys.js"></script>
<script type="text/javascript" src="js/ydui.js"></script>
<script type="text/javascript">

    $(function () {
        if(window!==parent){
            $("header").hide();
        }
        var id = getQueryString("id");
        if (id == null) return;
        //修改页面
				var btn = $("#save_or_update_btn");
        btn.attr("onclick","update('"+id+"')");
        btn.text("修改");
        $.ajax({
            url: "/wl_address/ads/" + id,
            type: "get",
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.flag) {
                    var item = data.item;
                    $("input[name=name]").val(item.name);
                    $("input[name=phone]").val(item.phone);
                    $("#J_Address").val(item.province + " " + item.city + " " + item.county);
                    $("input[name=location]").val(item.location);
                } else {
                    layer.msg(data.msg);
                }
            }
        });
    });

    function save() {
        var pcc = $("#J_Address").val();
        var param = {
            name: $("input[name=name]").val(),
            phone: $("input[name=phone]").val(),
            province: pcc.split(" ")[0],
            city: pcc.split(" ")[1],
            county: pcc.split(" ")[2],
            location: $("input[name=location]").val()
        };

        if(	  param.name==""||param.phone==""
            ||param.province==""||param.city==""
            ||param.county==""||param.location==""){
            alert("请输入完整的信息");
        }

        $.ajax({
            url: "/wl_address",
            type: "post",
            data: param,
            dataType: "json",
            success: function (data) {
                if (data.flag) {
                    $(".layui-layer-title", parent.document).text("收货地址");
                    location.href = "selectAddress.html";
                } else {
                    layer.msg(data.msg);
                }
            }
        });
    }
    
    function update(id) {
        var pcc = $("#J_Address").val();
        var param = {
            _method: "put",
            name: $("input[name=name]").val(),
            phone: $("input[name=phone]").val(),
            province: pcc.split(" ")[0],
            city: pcc.split(" ")[1],
            county: pcc.split(" ")[2],
            location: $("input[name=location]").val()
        };
        if(	  param.name==""||param.phone==""
            ||param.province==""||param.city==""
            ||param.county==""||param.location==""){
            alert("请输入完整的信息");
        }

        $.ajax({
            url: "/wl_address/"+id,
            type: "post",
            data: param,
            dataType: "json",
            success: function (data) {
                if (data.flag) {
                    $(".layui-layer-title", parent.document).text("收货地址");
                    location.href = "selectAddress.html";
                } else {
                    layer.msg(data.msg);
                }
            }
        });
    }

    /**
     * 省市区联动
     */
    !function () {
        var $target = $('#J_Address');
        $target.citySelect();
        $target.on('click', function (event) {
            event.stopPropagation();
            $target.citySelect('open');
        });
        $target.on('done.ydui.cityselect', function (ret) {
            $(this).val(ret.provance + ' ' + ret.city + ' ' + ret.area);
        });
    }();

    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var reg_rewrite = new RegExp("(^|/)" + name + "/([^/]*)(/|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        var q = window.location.pathname.substr(1).match(reg_rewrite);
        if (r != null) {
            return unescape(r[2]);
        } else if (q != null) {
            return unescape(q[2]);
        } else {
            return null;
        }
    }
</script>

</html>
