<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>提交订单</title>
	<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" name="viewport"/>
	<meta content="yes" name="apple-mobile-web-app-capable"/>
	<meta content="black" name="apple-mobile-web-app-status-bar-style"/>
	<meta content="telephone=no" name="format-detection"/>
	<link href="./css/style2.css" rel="stylesheet" type="text/css"/>
	<link href="../../layer/theme/default/layer.css" rel="stylesheet" type="text/css"/>
	<link href="../../css/bootstrap.min.css" rel="stylesheet">
</head>
<body style="background:#f7f7f7">
<section class="aui-flexView">
	<header class="aui-navBar aui-navBar-fixed">
		<a href="javascript:history.go(-1);" class="aui-navBar-item">
			<i class="icon icon-return"></i>
		</a>
		<div class="aui-center">
			<span class="aui-center-title">提交订单</span>
		</div>
	</header>
	<section class="aui-scrollView">
		<div class="aui-order-box">
			<div class="aui-flex aui-choice-white aui-mar15" id="selectAdress">
				
				<div id="address_info" style="display: none;">
					<div class="item" name="address">
						<div class="receiver">收货人：&nbsp;<smap name="ads_name" style="color: #505050;;"></smap>
						</div>
						<div class="phone" name="ads_phone"></div>
						<div class="address">收货地址：&nbsp;<smap style="color: #505050;" name="ads_address"></smap>
						</div>
					</div>
				</div>
				
				<div class="aui-flex-box placeholder">请选择收货地址</div>
				<div class="aui-flex-triangle" style="color:#fff">.</div>
			</div>
			<div class="aui-flex aui-choice-white">
				<div class="aui-flex-box">
					<h1>商品清单
						<smap name="goods_num"></smap>
						件
					</h1>
				</div>
			</div>
			<div class="aui-flex aui-flex-default aui-mar15">
				<div class="aui-flex-goods">
					<img name="goods_pic" src="" alt="">
				</div>
				<div class="aui-flex-box">
					<h2 name="goods_title"></h2>
					<p>规格：
						<smap name="goods_specs"></smap>
					</p>
					<div class="aui-flex aui-flex-clear">
						<div class="aui-flex-box">￥
							<smap name="goods_price"></smap>
						</div>
						<div>x
							<smap name="goods_num"></smap>
						</div>
					</div>
				</div>
			</div>
			<div class="aui-flex aui-choice-white b-line">
				<div class="aui-flex-box">支付方式</div>
				<select class="aui-flex-triangle">
					<option value="1" selected>线上转账</option>
				</select>
			</div>
			<div class="aui-flex aui-choice-white  aui-mar15">
				<div class="" style="font-size: 14px; color: #333;">买家留言</div>
				<input id="desc" type="text" placeholder="请填写备注" style="font-size: 14px;margin-left: 10px;width: 75%;">
			</div>
			<div class="aui-flex aui-choice-white ">
				<div class="aui-flex-box">
					<h4>商品总价</h4>
					<h4>应付定金</h4>
				</div>
				<div class="aui-flex-triangle aui-flex-triangle-clear" style="text-align: right">
					<h4 style="color: #f21956;">￥
						<smap name="total_price"></smap>
					</h4>
					<h4 style="color: #f21956;">￥
						<smap name="deposit_price"></smap>
					</h4>
					<div id="moneyup" style="color: #9E9E9E; position: absolute; bottom: -12px; font-size: 12px; width: 300px; right: 15px;display: none;">
						定金最高仅需支付(<smap name="deposit_price" style="color: #e46363;"></smap>)元哦
					</div>
				</div>
			</div>
		</div>
	</section>
	<footer class="aui-bar-footer">
		<div class="aui-flex">
			<div class="aui-flex-box">
				定金：<em>￥
				<smap name="deposit_price"></smap>
			</em>
			</div>
			<div class="aui-btn-button" onclick="toPay()">
				<button>支付定金</button>
			</div>
		</div>
	</footer>
</section>
<script src="../../js/jquery-1.11.3.min.js"></script>
<script src="../../js/layer.js"></script>
<script>

    var _gsid = getQueryString("gsid");
    var _num = getQueryString("num");
    $(function () {
        $.ajax({
            url: "/wx_wlgoods/goodsSpecs/" + _gsid,
            type: "get",
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.flag) {
                    console.log(data);
                    var item = data.item;
                    var g = item.goods;
                    var s = item.specs;
                    var total = parseFloat(parseInt(item.price) * parseInt(_num)).toFixed(2);
                    var deposit = parseFloat(parseInt(item.deposit) * parseInt(_num)).toFixed(2);
                    var moneyup = parseFloat(data.moneyup).toFixed(2);
                    $("[name=goods_title]").text(g.title);
                    $("[name=goods_price]").text(parseFloat(item.price).toFixed(2));
                    $("[name=goods_num]").text(_num);
                    $("[name=goods_specs]").text(s.name);
                    $("[name=goods_pic]").attr("src", JSON.parse(g.imgList)[0]);
                    if(deposit>moneyup){
                        $("[name=deposit_price]").text(moneyup);
                        $("#moneyup").show();
                    }else{
                        $("[name=deposit_price]").text(deposit);
                    }
                    $("[name=total_price]").text(total);
                } else {
                    layer.msg(data.msg);
                }
            }
        });
        $.ajax({
            url: "/wl_address//default",
            type: "get",
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.flag) {
                    console.log(data);
                    var item = data.item;
                    $("#selectAdress .placeholder").hide();
                    $("#address_info").show();
                    $("[name=ads_name]").text(item.name);
                    $("[name=ads_phone]").text(item.phone);
                    $("[name=ads_address]").text(item.province + item.city + item.county + item.location);
                    $("[name=address]").attr("id", item.id);
                } else {
                    layer.msg(data.msg);
                }
            }
        });
    });

    /**
     * 创建订单并且跳转到支付页面
     */
    function toPay() {
        var param = {
            gsId: _gsid,
            aId: $("[name=address]").attr("id"),
            num: _num,
            pay: 1,
            desc: $("#desc").val()
        }
        $.ajax({
            url: "/wx_wlorder/add",
            type: "post",
            data: param,
            dataType: "json",
            success: function (data) {
                if (data.flag) {
                    location.href="pay.html?id="+data.id;
                } else {
                    layer.msg(data.msg);
                }
            }
        });
    }

    $("#selectAdress").on("click", function () {
        var i = layer.open({
            type: 2,
            title: "收货地址",
            skin: "xx",
            area: ["100%", "100%"],
            maxmin: true,
            content: "selectAddress.html",
            success: function (index, layero) {
            },
            cancel: function (index, layero) {
            }
        });
        layer.full(i);
    });

    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var reg_rewrite = new RegExp("(^|/)" + name + "/([^/]*)(/|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        var q = window.location.pathname.substr(1).match(reg_rewrite);
        if (r != null) {
            return unescape(r[2]);
        } else if (q != null) {
            return unescape(q[2]);
        } else {
            return null;
        }
    }
</script>
</body>
</html>
